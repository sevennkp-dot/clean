<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏≠‡∏û‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --primary:#2563eb;
  --primary-dark:#1e40af;
  --bg:#f5f7fb;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --radius:16px;
}
*{box-sizing:border-box}
body{
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai",sans-serif;
  background:linear-gradient(180deg,#f8fafc,#eef2ff);
  margin:0;
  padding:12px;
  color:var(--text)
}
.container{max-width:480px;margin:auto}
.header{margin-bottom:16px}
.header h1{margin:0;font-size:22px;font-weight:700}
.header p{margin:6px 0 0;color:var(--muted);font-size:13px}
.card{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:14px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
.card h2{margin:0 0 12px;font-size:17px;font-weight:600}
label{display:block;font-size:14px;margin:10px 0 6px;color:#374151}
input,select,button{width:100%;padding:14px 14px;border-radius:14px;border:1px solid var(--border);font-size:16px}
button{background:var(--primary);color:#fff;border:none;font-weight:600}
button.secondary{background:#eef2ff;color:var(--primary)}
.option{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 14px;
  border:1px solid var(--border);
  border-radius:14px;
  margin-bottom:10px;
  background:#ffffff
}
.option label{display:flex;flex-direction:column;gap:2px;font-size:15px;color:var(--text)}
.option small{font-size:12px;color:var(--muted)}
.option input[type="checkbox"]{width:22px;height:22px;accent-color:var(--primary)}
.price-box{background:#f8fafc;border:1px dashed var(--border);border-radius:14px;padding:14px}
.price-box .total{font-size:22px;font-weight:700;color:var(--primary)}
.muted{color:var(--muted);font-size:13px}
.footer-action{position:sticky;bottom:0;background:#ffffff;padding:12px;border-top:1px solid var(--border)}
.brand-grid,.scent-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.brand-card,.scent-card{border:1px solid var(--border);border-radius:12px;padding:8px;text-align:center;font-size:13px;cursor:pointer}
.brand-card.active,.scent-card.active{border-color:var(--primary);background:#eef2ff}
.brand-card img{width:100%;height:60px;object-fit:contain}
</style>
</head>
<body>
<div class="container">
  <div id="landing" class="card">
    <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö üëã</h2>
    <p class="muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥</p>
    <button id="goOrder" style="margin-top:12px">üß∫ ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‚Äì‡∏™‡πà‡∏á‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤</button>
    <button id="goStatus" class="secondary" style="margin-top:10px">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å</button>
  </div>

  <div id="orderFlow" style="display:none">
    <div class="header">
      <h1>üß∫ ‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà</h1>
      <p>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
      <div id="orderMeta" class="muted" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <h2>1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å</h2>
      <select id="washType">
        <option value="‡∏£‡∏ß‡∏°">‡∏ã‡∏±‡∏Å‡∏£‡∏ß‡∏° (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)</option>
        <option value="‡πÅ‡∏¢‡∏Å‡∏™‡∏µ">‡πÅ‡∏¢‡∏Å‡∏™‡∏µ (‡∏Ñ‡∏¥‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</option>
      </select>
    </div>

    <div class="card">
      <h2>2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
      <label>‡∏ä‡∏∑‡πà‡∏≠</label><input id="name" />
      <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input id="phone" />
      <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label><input id="address" />
      <button type="button" id="btnLocation" class="secondary" style="margin-top:8px">üìç‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡∏ú‡πâ‡∏≤</button>
      <input type="hidden" id="lat" />
      <input type="hidden" id="lng" />
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡πâ‡∏≤</label><input type="date" id="pickup_date" />
      <label>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ú‡πâ‡∏≤</label>
      <select id="pickup_time">
        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ --</option>
        <option value="09:00-11:00">09:00 - 11:00 ‡∏ô.</option>
        <option value="11:00-13:00">11:00 - 13:00 ‡∏ô.</option>
        <option value="13:00-15:00">13:00 - 15:00 ‡∏ô.</option>
        <option value="15:00-17:00">15:00 - 17:00 ‡∏ô.</option>
        <option value="17:00-19:00">17:00 - 19:00 ‡∏ô.</option>
      </select>
    </div>

    <div class="card">
      <h2>4. ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ã‡∏±‡∏Å</h2>
      <select id="machine">
        <option value="‡πÄ‡∏•‡πá‡∏Å">‡πÄ‡∏•‡πá‡∏Å (9 ‡∏Å‡∏¥‡πÇ‡∏• ‚Ä¢ 80 ‡∏ö‡∏≤‡∏ó)</option>
        <option value="‡∏Å‡∏•‡∏≤‡∏á">‡∏Å‡∏•‡∏≤‡∏á (14 ‡∏Å‡∏¥‡πÇ‡∏• ‚Ä¢ 120 ‡∏ö‡∏≤‡∏ó)</option>
        <option value="‡πÉ‡∏´‡∏ç‡πà">‡πÉ‡∏´‡∏ç‡πà (18 ‡∏Å‡∏¥‡πÇ‡∏• ‚Ä¢ 160 ‡∏ö‡∏≤‡∏ó)</option>
      </select>
      <small class="muted">* 9 ‡∏Å‡∏Å. = ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πá‡∏Å, 14 ‡∏Å‡∏Å. = ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á, 18 ‡∏Å‡∏Å. = ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà</small>
    </div>

    <div class="card">
      <h2>5. ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°</h2>
      <label class="option"><div>‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏ú‡πâ‡∏≤‡∏ô‡∏∏‡πà‡∏°<br><small class="muted">‡πÄ‡∏•‡πá‡∏Å 10 ‚Ä¢ ‡∏Å‡∏•‡∏≤‡∏á 20 ‚Ä¢ ‡πÉ‡∏´‡∏ç‡πà 30 ‡∏ö‡∏≤‡∏ó</small></div><input type="checkbox" id="softener" /></label>
      <div id="softenerUI" style="display:none;margin-top:12px">
        <h3 style="font-size:15px;margin-bottom:6px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</h3>
        <div class="brand-grid">
          <div class="brand-card" data-brand="Downy"><img src="https://upload.wikimedia.org/wikipedia/commons/5/5f/Downy_fabric_softener_bottle.png" alt="Downy"><div>Downy</div></div>
          <div class="brand-card" data-brand="Comfort"><img src="https://upload.wikimedia.org/wikipedia/commons/2/2e/Comfort_fabric_conditioner.png" alt="Comfort"><div>Comfort</div></div>
          <div class="brand-card" data-brand="Hygiene"><img src="https://upload.wikimedia.org/wikipedia/commons/9/9c/Hygiene_fabric_softener.png" alt="Hygiene"><div>Hygiene</div></div>
        </div>
        <h3 style="font-size:15px;margin:12px 0 6px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏¥‡πà‡∏ô</h3>
        <div class="scent-grid">
          <div class="scent-card" data-scent="Lavender"><img src="https://upload.wikimedia.org/wikipedia/commons/6/6f/Lavender_flower.jpg" style="width:100%;height:50px;object-fit:cover;border-radius:8px"><div>Lavender</div></div>
          <div class="scent-card" data-scent="Rose"><img src="https://upload.wikimedia.org/wikipedia/commons/b/bf/Rose_flower.jpg" style="width:100%;height:50px;object-fit:cover;border-radius:8px"><div>Rose</div></div>
          <div class="scent-card" data-scent="Fresh"><img src="https://upload.wikimedia.org/wikipedia/commons/3/3a/Fresh_linen.jpg" style="width:100%;height:50px;object-fit:cover;border-radius:8px"><div>Fresh</div></div>
        </div>
        <div id="softenerPreview" class="muted" style="margin-top:8px"></div>
      </div>
      <label class="option"><div>‡∏£‡∏µ‡∏î‡∏ú‡πâ‡∏≤<br><small class="muted">‡πÄ‡∏•‡πá‡∏Å 30 ‚Ä¢ ‡∏Å‡∏•‡∏≤‡∏á 40 ‚Ä¢ ‡πÉ‡∏´‡∏ç‡πà 50 ‡∏ö‡∏≤‡∏ó</small></div><input type="checkbox" id="iron" /></label>
      <label class="option"><div>‡∏û‡∏±‡∏ö‡∏ú‡πâ‡∏≤<br><small class="muted">‡πÄ‡∏•‡πá‡∏Å 20 ‚Ä¢ ‡∏Å‡∏•‡∏≤‡∏á 30 ‚Ä¢ ‡πÉ‡∏´‡∏ç‡πà 40 ‡∏ö‡∏≤‡∏ó</small></div><input type="checkbox" id="fold" /></label>
      <label class="option"><div>‡∏£‡∏±‡∏ö‚Äì‡∏™‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô<br><small class="muted">‡πÄ‡∏•‡πá‡∏Å 40 ‚Ä¢ ‡∏Å‡∏•‡∏≤‡∏á 60 ‚Ä¢ ‡πÉ‡∏´‡∏ç‡πà 80 ‡∏ö‡∏≤‡∏ó</small></div><input type="checkbox" id="fastDelivery" /></label>
    </div>

    <div class="card" id="summaryCard">
      <h2>6. ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤</h2>
      <div class="price-box">
        <table style="width:100%;border-collapse:collapse;font-size:14px">
          <thead>
            <tr>
              <th style="text-align:left;padding:6px 0;border-bottom:1px dashed var(--border)">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th style="text-align:right;padding:6px 0;border-bottom:1px dashed var(--border)">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</th>
            </tr>
          </thead>
          <tbody id="priceDetail"></tbody>
          <tbody id="extraSubtotal"></tbody>
        </table>
        <div class="total" style="margin-top:10px">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="total">0</span> ‡∏ö‡∏≤‡∏ó</div>
      </div>
    </div>

    <div class="footer-action" id="footerAction">
      <button id="btnSubmit">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
      <button id="goStatusFromOrder" class="secondary" style="margin-top:8px">üîç ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
    </div>

    <!-- POPUP CONFIRM SUMMARY -->
    <div id="confirmModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:50;align-items:center;justify-content:center">
      <div style="background:#fff;border-radius:16px;max-width:420px;width:92%;padding:16px">
        <h3 style="margin:0 0 8px">üßæ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤</h3>
        <div id="confirmSummary" style="font-size:14px;margin-bottom:12px"></div>
        <div style="display:flex;gap:10px">
          <button id="btnCancelConfirm" class="secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button id="btnConfirmSave">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
    </div>
  </div>

  <div id="statusFlow" class="card" style="display:none">
    <button id="backFromStatus" class="secondary" style="margin-bottom:10px">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
    <h2>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h2>
    <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
    <input id="statusPhone" />
    <button id="btnCheckStatus" style="margin-top:12px">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
  </div>
</div>

<script>
// ===============================
// SUPABASE INIT (SAFE, DECLARE ONCE)
// ===============================
const SUPABASE_URL = "https://nqceenmwedhqpxakjoiq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xY2Vlbm13ZWRocXB4YWtqb2lxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjA2NTYsImV4cCI6MjA4MjY5NjY1Nn0.OD0eEvgj6Qklan43iLmUyjj73oAQ_0qX1ZYN5z6kUNs";

// ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ã‡πâ‡∏≥ (‡πÅ‡∏Å‡πâ error Identifier 'supabase' has already been declared)
const sb = window.__sb || (window.__sb = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
));

(function(){
  const goOrder=document.getElementById('goOrder');
  const goStatus=document.getElementById('goStatus');
  const backFromStatus=document.getElementById('backFromStatus');
  const goStatusFromOrder=document.getElementById('goStatusFromOrder');
  const landing=document.getElementById('landing');
  const orderFlow=document.getElementById('orderFlow');
  const statusFlow=document.getElementById('statusFlow');

  goOrder.onclick=()=>{landing.style.display='none';orderFlow.style.display='block';calc();};
  goStatus.onclick=()=>{landing.style.display='none';statusFlow.style.display='block'};
  backFromStatus.onclick=()=>{statusFlow.style.display='none';landing.style.display='block'};

  if(goStatusFromOrder){
    goStatusFromOrder.onclick=()=>{
      orderFlow.style.display='none';
      statusFlow.style.display='block';
    }
  }

  const prices={machine:{‡πÄ‡∏•‡πá‡∏Å:80,‡∏Å‡∏•‡∏≤‡∏á:120,‡πÉ‡∏´‡∏ç‡πà:160}};

  // ===== Order ID & Time =====
  function generateOrderId(){
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const day=String(d.getDate()).padStart(2,'0');
    const t=Date.now().toString().slice(-4);
    return `WASH-${y}${m}${day}-${t}`;
  }
  function formatDateTime(){
    const d=new Date();
    return d.toLocaleString('th-TH',{dateStyle:'short',timeStyle:'short'});
  }
  const orderId=generateOrderId();
  const orderTime=formatDateTime();
  const orderMeta=document.getElementById('orderMeta');
  if(orderMeta){
    orderMeta.textContent=`‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ${orderId} ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: ${orderTime}`;
  }
  const washTypeEl=document.getElementById('washType');
  const machineSel=document.getElementById('machine');
  const softener=document.getElementById('softener');
  const softenerUI=document.getElementById('softenerUI');
  const preview=document.getElementById('softenerPreview');
  let softenerBrand=null,softenerScent=null;
  const iron=document.getElementById('iron');
  const fold=document.getElementById('fold');
  const fastDelivery=document.getElementById('fastDelivery');
  const priceDetail=document.getElementById('priceDetail');
  const totalEl=document.getElementById('total');

  softener.onchange=()=>{softenerUI.style.display=softener.checked?'block':'none';calc();};

  document.querySelectorAll('.brand-card').forEach(b=>b.onclick=()=>{
    document.querySelectorAll('.brand-card').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');softenerBrand=b.dataset.brand;updatePreview();calc();
  });
  document.querySelectorAll('.scent-card').forEach(s=>s.onclick=()=>{
    document.querySelectorAll('.scent-card').forEach(x=>x.classList.remove('active'));
    s.classList.add('active');softenerScent=s.dataset.scent;updatePreview();calc();
  });
  function updatePreview(){
    preview.textContent=softenerBrand&&softenerScent?`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${softenerBrand} - ${softenerScent}`:'';
  }

  function calc(){
    let total=0;const d=[];
    const size=machineSel.value;
    total+=prices.machine[size];
    d.push(`‡∏Ñ‡πà‡∏≤‡∏ã‡∏±‡∏Å ${prices.machine[size]}`);

    if(washTypeEl.value==='‡πÅ‡∏¢‡∏Å‡∏™‡∏µ'){
      const s={‡πÄ‡∏•‡πá‡∏Å:20,‡∏Å‡∏•‡∏≤‡∏á:30,‡πÉ‡∏´‡∏ç‡πà:40}[size];
      total+=s;d.push(`‡πÅ‡∏¢‡∏Å‡∏™‡∏µ ${s}`)
    }
    if(softener.checked){const so={‡πÄ‡∏•‡πá‡∏Å:10,‡∏Å‡∏•‡∏≤‡∏á:20,‡πÉ‡∏´‡∏ç‡πà:30}[size];total+=so;d.push(`‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏ú‡πâ‡∏≤‡∏ô‡∏∏‡πà‡∏° ${so}`)}
    if(iron.checked){const p={‡πÄ‡∏•‡πá‡∏Å:30,‡∏Å‡∏•‡∏≤‡∏á:40,‡πÉ‡∏´‡∏ç‡πà:50}[size];total+=p;d.push(`‡∏£‡∏µ‡∏î‡∏ú‡πâ‡∏≤ ${p}`)}
    if(fold.checked){const f={‡πÄ‡∏•‡πá‡∏Å:20,‡∏Å‡∏•‡∏≤‡∏á:30,‡πÉ‡∏´‡∏ç‡πà:40}[size];total+=f;d.push(`‡∏û‡∏±‡∏ö‡∏ú‡πâ‡∏≤ ${f}`)}
    if(fastDelivery.checked){const e={‡πÄ‡∏•‡πá‡∏Å:40,‡∏Å‡∏•‡∏≤‡∏á:60,‡πÉ‡∏´‡∏ç‡πà:80}[size];total+=e;d.push(`‡∏£‡∏±‡∏ö‚Äì‡∏™‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô ${e}`)}

    let extraSum=0;
    priceDetail.innerHTML = d.map(row=>{
      const parts=row.split(' ');
      const price=parseInt(parts.pop(),10);
      const label=parts.join(' ');
      if(label!=='‡∏Ñ‡πà‡∏≤‡∏ã‡∏±‡∏Å') extraSum+=price;
      return `<tr><td style="padding:4px 0">${label} (${size})</td><td style="text-align:right">${price}</td></tr>`;
    }).join('');
    document.getElementById('extraSubtotal').innerHTML = extraSum>0
      ? `<tr><td style=\"padding-top:6px;border-top:1px dashed var(--border)\">‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°</td><td style=\"text-align:right;border-top:1px dashed var(--border)\">${extraSum}</td></tr>`
      : '';
    totalEl.textContent=total;
  }

  document.querySelectorAll('input,select').forEach(el=>el.addEventListener('change',calc));
  const btnLocation=document.getElementById('btnLocation');
  const latEl=document.getElementById('lat');
  const lngEl=document.getElementById('lng');
  const addressEl=document.getElementById('address');

  if(btnLocation){
    btnLocation.onclick=()=>{
      if(!navigator.geolocation){
        alert('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');return;
      }
      btnLocation.textContent='üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î...';
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude.toFixed(6);
        const lng=pos.coords.longitude.toFixed(6);
        latEl.value=lat; lngEl.value=lng;
        addressEl.value += addressEl.value?` (‡∏û‡∏¥‡∏Å‡∏±‡∏î ${lat},${lng})`:`‡∏û‡∏¥‡∏Å‡∏±‡∏î ${lat},${lng}`;
        btnLocation.textContent='‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß';
      },()=>{
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
        btnLocation.textContent='üìç ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡∏ú‡πâ‡∏≤';
      });
    }
  }
  // ===============================
  // SAVE ORDER (SHOW CONFIRM POPUP FIRST)
  // ===============================
  const btnSubmit = document.getElementById('btnSubmit');
  if(btnSubmit){
    btnSubmit.onclick = ()=>{
      // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
      calc();
      const rows = [...priceDetail.querySelectorAll('tr')]
        .map(r=>`<div>${r.children[0].innerText} : ${r.children[1].innerText} ‡∏ö‡∏≤‡∏ó</div>`)
        .join('');
      document.getElementById('confirmSummary').innerHTML =
        rows + `<hr><b>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalEl.textContent} ‡∏ö‡∏≤‡∏ó</b>`;
      document.getElementById('confirmModal').style.display='flex';
    };
  }

  const btnConfirmSave=document.getElementById('btnConfirmSave');
  const btnCancelConfirm=document.getElementById('btnCancelConfirm');

  btnCancelConfirm.onclick=()=>{
    document.getElementById('confirmModal').style.display='none';
  };

  btnConfirmSave.onclick = async ()=>{
    document.getElementById('confirmModal').style.display='none';
    const payload = {
      order_id: orderId,
      name: document.getElementById('name').value,
      phone: document.getElementById('phone').value.replace(/\\D/g,''),
      address: document.getElementById('address').value,
      lat: document.getElementById('lat').value || null,
      lng: document.getElementById('lng').value || null,
      pickup_date: document.getElementById('pickup_date').value,
      pickup_time: document.getElementById('pickup_time').value,
      wash_type: washTypeEl.value,
      machine_size: machineSel.value,
      softener: softener.checked,
      softener_brand: softenerBrand,
      softener_scent: softenerScent,
      iron: iron.checked,
      fold: fold.checked,
      fast_delivery: fastDelivery.checked,
      total_price: parseInt(totalEl.textContent,10),      status: '‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå'
    };

    const { error } = await sb.from('orders').insert([payload]);
    if(error){
      alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      console.error(error);
      return;
    }
    alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ${orderId}`);
    document.querySelectorAll('#orderFlow input').forEach(i=>{i.type==='checkbox'?i.checked=false:i.value=''});
    document.querySelectorAll('#orderFlow select').forEach(s=>s.selectedIndex=0);
    softenerBrand=null;softenerScent=null;
    document.querySelectorAll('.brand-card,.scent-card').forEach(x=>x.classList.remove('active'));
    document.getElementById('softenerUI').style.display='none';
    document.getElementById('softenerPreview').textContent='';
    totalEl.textContent='0';priceDetail.innerHTML='';
  }

  // ===============================
  // CHECK STATUS BY PHONE
  // ===============================
  const btnCheckStatus = document.getElementById('btnCheckStatus');
  if(btnCheckStatus){
    btnCheckStatus.onclick = async ()=>{
      const phone = document.getElementById('statusPhone').value.replace(/\\D/g,'');
      const { data, error } = await sb
        .from('orders')
        .select('order_id,status,total_price,created_at')
        .eq('phone', phone)
        .order('created_at', { ascending:false })
        .limit(1);

      if(error || !data || !data.length){
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå');
        return;
      }
      const o = data[0];
      alert(
        `‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ${o.order_id}\n`+
        `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${o.status}\n`+
        `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${o.total_price} ‡∏ö‡∏≤‡∏ó`
      );
    }
  }
})();
</script>
</body>
</html>

